<!DOCTYPE html>
<html class="no-js">
  <head>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Rails中什么时候需要require</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

<!-- CSS -->
<link rel="stylesheet" href="/css/owl.carousel.css" />
<link rel="stylesheet" href="/css/bootstrap.min.css" />
<link rel="stylesheet" href="/css/font-awesome.min.css" />
<link rel="stylesheet" href="/css/airspace.css" />
<link rel="stylesheet" href="/css/style.css" />
<link rel="stylesheet" href="/css/ionicons.min.css" />
<link rel="stylesheet" href="/css/animate.css" />
<link rel="stylesheet" href="/css/responsive.css" />
<link rel="stylesheet" href="/css/syntax.css" />

<!-- Js -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/plugins.js"></script>
<script src="/js/min/waypoints.min.js"></script>
<script src="/js/jquery.counterup.js"></script>


<script src="/js/main.js"></script>

<!--
/*
 * Airspace
 * Ported to Jekyll by Andrew Lee
 * https://github.com/luminousrubyist/airspace-jekyll
 * Designed and Developed by ThemeFisher
 * https://themefisher.com/
 *
 */
-->


  </head>
  <body>


    <!-- Header Start -->
<header>
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <!-- header Nav Start -->
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html" >
              <img src="/img/logo.png" alt="Logo" style="width: 70px">
            </a>
          </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav navbar-right">
                <li><a href="/">主页</a></li>
                <!--<li><a href="/work">Work</a></li>-->
                <li><a href="/blog">博客</a></li>
                <!--<li><a href="#">Service</a></li>-->
                <li><a href="/contact">联系我</a></li>
              </ul>
            </div><!-- /.navbar-collapse -->
          </div><!-- /.container-fluid -->
        </nav>
      </div>
    </div>
  </div>
</header><!-- header close -->



    <div class="post">
  <!-- Wrapper Start -->
  <section id="intro" style="border: 1px dotted #ddd;">
    <div class="container">
      <div class="row">
        <div>
          <div class="block">
            <h1>Rails中什么时候需要require</h1>
            <div class="post-info-wrapper">
              <p class="italic">By <span class="bold">meedesidy</span> on <span class="bold">July 17, 2017</span></p>
            </div>
            <hr />
            <p><h2 id="rails中什么时候需要require">Rails中什么时候需要require</h2>

<p><strong><code class="highlighter-rouge">Scene</code></strong>  在现在的ROR开发中，比如在用户的控制器中使用下面一段代码：</p>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">test</span>
    <span class="nb">p</span> <span class="no">User</span><span class="p">.</span><span class="nf">name</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre>
</div>
<p><strong><code class="highlighter-rouge">Qustion</code></strong> 然而在<code class="highlighter-rouge">Controller</code>中并没有任何的<code class="highlighter-rouge">require</code>或者<code class="highlighter-rouge">import</code>或者<code class="highlighter-rouge">include</code>等动作，那<code class="highlighter-rouge">User</code>类是怎么加载到<code class="highlighter-rouge">controller</code>中的呢？</p>

<h3 id="整理这个问题的时候我顺便找到了关于-ruby-内核类加载机制-">整理这个问题的时候,我顺便找到了关于 <a href="http://www.baidu.com">Ruby 内核类加载机制 </a></h3>

<h4 id="load_path">$LOAD_PATH</h4>

<ul>
  <li>在<code class="highlighter-rouge">Rails</code>项目中有很多第三方库，如果要对第三方库和业务代码进行管理，即<code class="highlighter-rouge">$LOAD_PATH</code></li>
  <li><code class="highlighter-rouge">Ruby</code>并不要求统一管理类，理论上我们的类文件可以遍布整个系统各个角落，意味着我们需要为每个文件制定一个绝对路径活着相对路径</li>
  <li><code class="highlighter-rouge">$LOAD_PATH</code>是一个字符串数组，元素是一堆路径
    <pre><code class="language-irb">  irb(main):001:0&gt; $:
  =&gt; ["/home/baily/.rbenv/plugins/rbenv-gem-rehash", "/home/baily/.rbenv/rbenv.d/exec/gem-rehash", "/home/baily/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/did_you_mean-1.0.0/lib", "/home/baily/.rbenv/versions/2.3.1/lib/ruby/site_ruby/2.3.0", "/home/baily/.rbenv/versions/2.3.1/lib/ruby/site_ruby/2.3.0/x86_64-linux", "/home/baily/.rbenv/versions/2.3.1/lib/ruby/site_ruby", "/home/baily/.rbenv/versions/2.3.1/lib/ruby/vendor_ruby/2.3.0", "/home/baily/.rbenv/versions/2.3.1/lib/ruby/vendor_ruby/2.3.0/x86_64-linux", "/home/baily/.rbenv/versions/2.3.1/lib/ruby/vendor_ruby", "/home/baily/.rbenv/versions/2.3.1/lib/ruby/2.3.0", "/home/baily/.rbenv/versions/2.3.1/lib/ruby/2.3.0/x86_64-linux"]
  irb(main):002:0&gt;
</code></pre>
  </li>
  <li>这样就可以很方便对类库进行管理，和新类库的添加
    <blockquote>
      <p>$:.unshift File.dirname(<strong>FILE</strong>) //添加新路径</p>
    </blockquote>
  </li>
</ul>

<h4 id="ruby-kernel-中的类加载">Ruby Kernel 中的类加载</h4>

<p><strong>Ruby 内核提供了 4 个类加载命令，分别是 load, autoload, require, require_relative, 分别对应了不同的使用场景</strong></p>

<ul>
  <li>
    <p>load(filename, wrap=false):</p>

    <blockquote>
      <p>每次重新加载整个文件，成功返回true,失败抛出异常，wrap为true时，被加载文件会在一个匿名模块中执行，避免污染；</p>
    </blockquote>
  </li>
  <li>
    <p>autoload(module, filename):</p>

    <blockquote>
      <p>将filename与module关联，当第一次使用module时，使用require加载该文件;成功返回nil,失败抛出异常</p>
    </blockquote>
  </li>
  <li>require(name):
    <blockquote>
      <p>函数执行时，如果name是绝对路径，则会去查找该文件；通常name是相对路径，需要$:.unshift添加搜索路径；,Ruby会在$:中的目录中搜索该文件,第一次加载返回true，已经加载返回false，找不到文件会抛出LoadError</p>
    </blockquote>
  </li>
  <li>require_relative(filename):
    <blockquote>
      <p>直接取相对路径。此时与$LOAD_PATH($:)无关，是文件本身路径的相对地址</p>
    </blockquote>
  </li>
</ul>

<h3 id="activesupport-对内核类加载的扩展">ActiveSupport 对内核类加载的扩展</h3>

<p><strong>Active Support 是 Rails 裡的工具函式庫，它也擴充了一些 Ruby 標準函式庫。除了被用在 Rails 核心程式中，你也可以在你的程式中使用</strong></p>

<h4 id="autoload-扩展">autoload 扩展</h4>
<p><strong>除了<code class="highlighter-rouge">ActiveSupport</code>对gem的扩展，在<code class="highlighter-rouge">Rails</code>中，维护了一个类似<code class="highlighter-rouge">$LOAD_PATH</code>的变量<code class="highlighter-rouge">autoload_paths</code></strong></p>

<ul>
  <li>Rails 3 中默认会将 <code class="highlighter-rouge">app</code> 下的子目录以及 lib 目录全部加入 <code class="highlighter-rouge">autoload_paths</code>, Rails 4 中去掉了 lib.</li>
  <li>
    <p>以下是一个刚生成的 Rails 3 项目的 <code class="highlighter-rouge">autoload</code> 路径:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  $ bin/rails r 'puts ActiveSupport::Dependencies.autoload_paths'
  .../app/assets
  .../app/controllers
  .../app/helpers
  .../app/mailers
  .../app/models
  .../app/controllers/concerns
  .../app/models/concerns
  .../test/mailers/previews
  .../lib
</code></pre>
    </div>
  </li>
  <li>
    <p>在 Rails 中还可以添加自定义的 autoload 路径:</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code>  <span class="c1"># config/application.rb</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/something"</span>
</code></pre>
    </div>
  </li>
</ul>

<p><strong><code class="highlighter-rouge">autoload_paths</code> 实际上是在 <code class="highlighter-rouge">ActiveSupport::Dependencies.autoload_paths</code> 中定义的, 这是一个 <code class="highlighter-rouge">String Array</code>, 可见 <code class="highlighter-rouge">Rails</code> 的 <code class="highlighter-rouge">autoload</code> 本质上是 <code class="highlighter-rouge">ActiveSupport</code> 的 <code class="highlighter-rouge">autoload</code> 机制</strong></p>

<ul>
  <li>以下代码将当前目录加入<code class="highlighter-rouge">autoload_paths</code>, 这样在<code class="highlighter-rouge">Ruby</code>找不到某个常量定义的时候，<code class="highlighter-rouge">ActiveSupport</code>就会尝试找到常量定义文件并自动加载.
    <div class="highlighter-rouge"><pre class="highlight"><code>  ActiveSupport::Dependencies.autoload_paths &lt;&lt; '.'
</code></pre>
    </div>
  </li>
  <li>
    <p><strong>到这里<code class="highlighter-rouge">rails</code>项目中就可以在业务代码中互相访问了, 在<code class="highlighter-rouge">autoload_path</code>中没有包含的路径，则需要添加</strong></p>
  </li>
  <li>查询<code class="highlighter-rouge">autoload_path</code>
    <blockquote>
      <p>bin/rails r ‘puts ActiveSupport::Dependencies.autoload_paths’ # 查询autoload_path</p>
    </blockquote>
  </li>
  <li>添加<code class="highlighter-rouge">autoload_path</code>
    <blockquote>
      <p>config.autoload_paths « ”#{Rails.root}/something” # 添加autoload_path</p>
    </blockquote>
  </li>
  <li>也可以在代码中添加<code class="highlighter-rouge">require</code>
    <blockquote>
      <p>require ‘../test.rb’ # 如果name是绝对路径，则会去查找该文件；通常name是相对路径，需要$:.unshift添加搜索路径；</p>
    </blockquote>
  </li>
</ul>

<p><strong><code class="highlighter-rouge">Answer</code>：</strong></p>

<ul>
  <li>
    <p><code class="highlighter-rouge">User</code>加载到<code class="highlighter-rouge">UsersController</code>是通过<code class="highlighter-rouge">Rails</code>的扩展库<code class="highlighter-rouge">ActiveSupport</code>维护的一个类似<code class="highlighter-rouge">$LOAD_PATH</code>的一个变量<code class="highlighter-rouge">autoload_path</code>管理文件的<code class="highlighter-rouge">load</code>之类的行为,他默认路径包含<code class="highlighter-rouge">app/</code>之下的几个文件夹(受rails版本，可能不相同)，<code class="highlighter-rouge">/controller</code>和<code class="highlighter-rouge">model</code>在其中，所以可以在<code class="highlighter-rouge">controller</code>中访问<code class="highlighter-rouge">model</code>信息</p>
  </li>
  <li>也就是说在<code class="highlighter-rouge">rails3</code>以下路径下都是不用<code class="highlighter-rouge">include</code>, <code class="highlighter-rouge">require</code>, <code class="highlighter-rouge">import</code>这类行为，就可以使用
    <div class="highlighter-rouge"><pre class="highlight"><code>  .../app/assets
  .../app/controllers
  .../app/helpers
  .../app/mailers
  .../app/models
  .../app/controllers/concerns
  .../app/models/concerns
  .../test/mailers/previews
  .../lib
</code></pre>
    </div>
  </li>
  <li>而在<code class="highlighter-rouge">autoload_path</code>中不包含的路径就需要手动<code class="highlighter-rouge">require</code>,像这样：
    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code>  <span class="c1">## Rails 5</span>
  <span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span><span class="o">::</span><span class="no">Base</span>
    <span class="c1"># rails的autoload没有lib的路径</span>
    <span class="c1"># $LOAD_PATH中 $: 中有lib的路径，所以不需要require全路径</span>
    <span class="nb">require</span> <span class="s1">'util/myutil'</span>
  <span class="k">end</span>
</code></pre>
    </div>
  </li>
</ul>

</p>
          </div>
        </div><!-- .col-md-7 close -->
      </div>
    </div>
  </section>
</div>
<p class="center-text" style="padding: 30px;">
  <a href="/blog">Back to blog</a>
</p>











    <!-- footer Start -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="footer-manu">
          <ul>
            <li><a href="#">About Us</a></li>
            <li><a href="/contact">Contact us</a></li>
            <li><a href="#">How it works</a></li>
            <li><a href="/blog">Blog</a></li>
            <li><a href="#">Terms</a></li>
          </ul>
        </div>
        <p>Copyright &copy; Design &amp; Developed by <a href="http://www.themefisher.com">Themefisher</a>. All rights reserved.</p>
      </div>
    </div>
  </div>
</footer>


    </body>
</html>
